---
title: "kind ç’°å¢ƒã« Prometheus ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
date: 2021-03-07
lastmod: 2021-05-21
categories: [ "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°" ]
tags: [ "kubernetes" ]
---

kind ã§ä½œã£ãŸ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã« Prometheus ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

### kind ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œã‚‹

ã¾ãš kind ã§ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã‚¿ã¯ã²ã¨ã¾ãš 4 ãƒãƒ¼ãƒ‰ã§ä½œã‚Šã¾ã™ã€‚

#### cluster.yaml

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
- role: worker
```

```console
$ # kind 0.11.0 + Kubernetes 1.21.1
$ kind create cluster --config cluster.yaml
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.21.1) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
 âœ“ Joining worker nodes ğŸšœ 
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Thanks for using kind! ğŸ˜Š
```

```console
$ kubectl get nodes
NAME                 STATUS   ROLES                  AGE     VERSION
kind-control-plane   Ready    control-plane,master   2m14s   v1.21.1
kind-worker          Ready    <none>                 106s    v1.21.1
kind-worker2         Ready    <none>                 106s    v1.21.1
kind-worker3         Ready    <none>                 106s    v1.21.1
```

### Prometheus ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

æ¬¡ã«ã€Prometheus ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ ConfigMap ã®å½¢ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
ã“ã® YAML ã‚’ç·¨é›†ã™ã‚‹ã¨ Prometheus ã®å‹•ä½œã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ã€‚

`prometheus.yml` ã®æ›¸ãæ–¹ã¯ [å…¬å¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«](https://prometheus.io/docs/prometheus/latest/configuration/configuration/) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

#### prometheus-config.yaml

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus
data:
  prometheus.yml: |
    scrape_configs:
      - job_name: prometheus
        static_configs:
          - targets:
            - localhost:9090
```

```console
$ kubectl apply -f prometheus-config.yaml 
configmap/prometheus created
```

### Prometheus ã® Pod ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

æ¬¡ã« Prometheus ã® Pod ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
Prometheus ã® [å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è¨­å®š](https://hub.docker.com/r/prom/prometheus/tags) ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãƒ‘ã‚¹ã¯ `/etc/prometheus/prometheus.yml` ã«ãªã£ã¦ã„ã¾ã™ã€‚

#### prometheus.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: prometheus
  labels:
    app: prometheus
spec:
  containers:
    - name: prometheus
      image: prom/prometheus:v2.27.1
      volumeMounts:
        - name: config
          mountPath: /etc/prometheus
          readOnly: true
  volumes:
    - name: config
      configMap:
        name: prometheus
        items:
          - key: prometheus.yml
            path: prometheus.yml
```

```console
$ kubectl apply -f prometheus.yaml 
pod/prometheus created
```

Prometheus ã¯ [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ](https://prometheus.io/docs/introduction/first_steps/#starting-prometheus) ã§ 9090 ç•ªãƒãƒ¼ãƒˆã§é€šä¿¡ã‚’å¾…æ©Ÿã—ã¾ã™ã€‚

```console
$ kubectl exec -it prometheus -- sh
/prometheus $ netstat -tln
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       
tcp        0      0 :::9090                 :::*                    LISTEN 
/prometheus $ wget -q -O - http://localhost:9090/
<!doctype html>
...
```

### Prometheus ã® Service ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

Prometheus ã‚’ã‚¯ãƒ©ã‚¹ã‚¿å†…ã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãŸã‚ã€Service ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
Pod ã«ã¯ `app: prometheus` ã¨ã„ã†ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã¦ãŠã„ãŸã®ã§ã€ã“ã®ãƒ©ãƒ™ãƒ«ã‚’ä½¿ã£ã¦ Pod ã‚’é¸æŠã—ã¾ã™ã€‚

#### prometheus-service.yaml

```yaml
apiVersion: v1
kind: Service
metadata:
  name: prometheus
spec:
  selector:
    app: prometheus
  ports:
    - port: 9090
```

```console
$ kubectl apply -f prometheus-service.yaml 
service/prometheus created
```

`kubectl port-forward` ã‚’ä½¿ãˆã°ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å‹•ä½œã‚’ç¢ºèªã§ãã¾ã™ã€‚

```console
$ kubectl port-forward service/prometheus 9090
Forwarding from 127.0.0.1:9090 -> 9090
Forwarding from [::1]:9090 -> 9090
```

[kind ç’°å¢ƒã« Grafana ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹](/2021/03/08) ã«ç¶šãã¾ã™ã€‚

{{< twitter >}}

## å‚è€ƒè³‡æ–™
- Prometheus - Monitoring system &amp; time series database<br />
  <span style="word-break: break-all;">
  https://prometheus.io/
  </span>

- First steps | Prometheus / Starting Prometheus<br />
  <span style="word-break: break-all;">
  https://prometheus.io/docs/introduction/first_steps/#starting-prometheus
  </span>

- Configuration | Prometheus<br />
  <span style="word-break: break-all;">
  https://prometheus.io/docs/prometheus/latest/configuration/configuration/
  </span>

- prom/prometheus | Docker Hub<br />
  <span style="word-break: break-all;">
  https://hub.docker.com/r/prom/prometheus
  </span>

- Prometheus: Up & Running<br />
  <span style="word-break: break-all;">
  https://www.oreilly.com/library/view/prometheus-up/9781492034131/
  </span>

- kind<br />
  <span style="word-break: break-all;">
  https://kind.sigs.k8s.io/
  </span>

- kind - Quick Start / Advanced / Configuring Your kind Cluster<br />
  <span style="word-break: break-all;">
  https://kind.sigs.k8s.io/docs/user/quick-start/#configuring-your-kind-cluster
  </span>
